SELECT t1.HOSPCODE
,t3.hosname AS HOSPNAME
,t1.TOTAL_AD
,t2.ANTIBIOTIC_AD
,FORMAT(t2.ANTIBIOTIC_AD/t1.TOTAL_AD*100,2) as PERCENTAGE
FROM 
(
SELECT  d.HOSPCODE,COUNT(DISTINCT d.HOSPCODE,d.PID,d.SEQ) as TOTAL_AD
FROM diagnosis_opd d
WHERE SUBSTR(d.DIAGCODE,1,4) IN ("A000","A001","A009","A020","A030", 
"A031","A032","A033","A038","A039","A040","A041","A042","A043","A044","A045","A046","A047","A048","A049","A050", 
"A053","A054","A059","A080","A081","A082","A083","A084","A085","A090","A099","K521","K528","K529")
AND d.DATE_SERV BETWEEN '2017-01-01'  AND '2017-05-31'
GROUP BY d.HOSPCODE 
) as t1 
LEFT JOIN 
(
SELECT  d.HOSPCODE,COUNT(DISTINCT d.HOSPCODE,d.PID,d.SEQ) as ANTIBIOTIC_AD
FROM diagnosis_opd d
LEFT JOIN drug_opd r
ON d.HOSPCODE=r.HOSPCODE  AND d.PID=r.PID AND d.SEQ=r.SEQ
LEFT JOIN c_antibioticss c
ON substr(r.DIDSTD,1,19)=c.stdcode
WHERE SUBSTR(d.DIAGCODE,1,4) IN ("A000","A001","A009","A020","A030", 
"A031","A032","A033","A038","A039","A040","A041","A042","A043","A044","A045","A046","A047","A048","A049","A050", 
"A053","A054","A059","A080","A081","A082","A083","A084","A085","A090","A099","K521","K528","K529")
AND d.DATE_SERV BETWEEN '2017-01-01'  AND '2017-05-31'
AND  NOT ISNULL(c.stdcode)
GROUP BY d.HOSPCODE 
) as t2
ON t1.HOSPCODE=t2.HOSPCODE
LEFT JOIN chospital t3
ON t1.HOSPCODE=t3.hoscode
