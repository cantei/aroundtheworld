SELECT t1.HOSPCODE
,t3.hosname  AS HOSPNAME
,t1.TOTAL_RI
,t2.ANTIBIOTIC_RI
,FORMAT(t2.ANTIBIOTIC_RI/t1.TOTAL_RI*100,2) as PERCENTAGE
FROM 
(
SELECT  d.HOSPCODE,COUNT(DISTINCT d.HOSPCODE,d.PID,d.SEQ) as TOTAL_RI
FROM diagnosis_opd d
WHERE SUBSTR(d.DIAGCODE,1,4) IN ("H650","H651","H659","H660","H664","H669", "H670","H671","H678","H720","H721",
"H722","H728","H729","J00","J010","J011","J012","J013","J014","J018","J019", 
 "J020","J029","J030","J038","J039","J040","J041","J042","J050","J051","J060","J068","J069", 
 "J101","J111","J200","J201","J202","J203","J204","J205","J206","J207","J208","J209","J210","J218","J219")
AND d.DATE_SERV BETWEEN '2017-01-01'  AND '2017-05-31'
GROUP BY d.HOSPCODE 
) as t1 
LEFT JOIN 
(
SELECT  d.HOSPCODE,COUNT(DISTINCT d.HOSPCODE,d.PID,d.SEQ) as ANTIBIOTIC_RI
FROM diagnosis_opd d
LEFT JOIN drug_opd r
ON d.HOSPCODE=r.HOSPCODE  AND d.PID=r.PID AND d.SEQ=r.SEQ
LEFT JOIN c_antibioticss c
ON substr(r.DIDSTD,1,19)=c.stdcode
WHERE SUBSTR(d.DIAGCODE,1,4) IN ("H650","H651","H659","H660","H664","H669", "H670","H671","H678","H720","H721",
"H722","H728","H729","J00","J010","J011","J012","J013","J014","J018","J019", 
 "J020","J029","J030","J038","J039","J040","J041","J042","J050","J051","J060","J068","J069", 
 "J101","J111","J200","J201","J202","J203","J204","J205","J206","J207","J208","J209","J210","J218","J219")
AND d.DATE_SERV BETWEEN '2017-01-01'  AND '2017-05-31'
AND  NOT ISNULL(c.stdcode)
GROUP BY d.HOSPCODE 
) as t2
ON t1.HOSPCODE=t2.HOSPCODE
LEFT JOIN chospital t3
ON t1.HOSPCODE=t3.hoscode
